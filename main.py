#! /usr/bin/python3

import requests
import threading
import sys

def die(msg):
    sys.stderr.write(msg + '\n')
    exit(1)
    
class Susie:

    def __init__(self):
        self.sessions = dict()

    def trick(self, autologins_unsub, autologins_sus, susie):
        self.susie = susie

        for login in autologins_unsub:
            self.unsubscribe(login)

        self.subscribe_all_at_the_same_time(autologins_sus)

    def connect(self, autologin):
        s = requests.Session()
        self.sessions[autologin] = s

        r = s.get(autologin)
        if (r.status_code == 200):
            print('connection success for autologin {}'.format(autologin))
        else:
            die('failure : {} for autologin {}'.format(r.status_code, autologin))

    def unsubscribe(self, autologin):
        self.connect(autologin)

        r = self.sessions[autologin].post(self.susie + 'unsubscribe?format=json&registercalendar')
        print('unsubscribe : {}'.format(r.status_code))

    def subscribe_all_at_the_same_time(self, autologins):
        
        for login in autologins:
            self.connect(login)

        for login in autologins:
            t = threading.Thread(target = self.subscribe, args = ([login]))
            t.start()

    def subscribe(self, *args):

        login = args[0]
        r = self.sessions[login].post(self.susie + 'subscribe?format=json&registercalendar')
        print('subscribe {} - {}'.format(login, r.status_code))

if __name__ == '__main__':

    su = Susie()
    people_to_unsubscribe = [
           # autologins urls here 
    ]
    people_to_subscribe = people_to_unsubscribe + [
          # autologins urls here
    ]
                                                   
    susie_url = 'https://intra.epitech.eu/planning/1919/26886/'

    su.trick(people_to_unsubscribe, people_to_subscribe, susie_url)
